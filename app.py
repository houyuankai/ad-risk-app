import streamlit as st
import pandas as pd
import numpy as np
import seaborn as sns
import matplotlib.pyplot as plt
from sklearn.ensemble import RandomForestClassifier
from sklearn.model_selection import train_test_split
from sklearn.metrics import confusion_matrix, roc_curve, auc, classification_report
from fpdf import FPDF

# ==========================================
# 0. PDF ç”Ÿæˆå‡½å¼ (å®‰å…¨è‹±æ–‡ç‰ˆ)
# ==========================================
def create_pdf(user_name, risk_type, prob, factors):
    pdf = FPDF()
    pdf.add_page()
    pdf.set_font("Arial", 'B', 16)
    pdf.cell(200, 10, txt="Alzheimer's Risk Assessment Report", ln=1, align='C')
    pdf.ln(10)
    
    tw_time = pd.Timestamp.now() + pd.Timedelta(hours=8)
    pdf.set_font("Arial", size=12)
    pdf.cell(200, 10, txt=f"User ID: {user_name}", ln=1)
    pdf.cell(200, 10, txt=f"Date: {tw_time.strftime('%Y-%m-%d %H:%M')}", ln=1)
    pdf.ln(5)
    
    pdf.set_font("Arial", 'B', 14)
    pdf.cell(200, 10, txt=f"Risk Level: {risk_type}", ln=1)
    pdf.cell(200, 10, txt=f"Probability: {prob:.1%}", ln=1)
    pdf.ln(5)
    
    pdf.set_font("Arial", 'B', 12)
    pdf.cell(200, 10, txt="Key Risk Factors:", ln=1)
    pdf.set_font("Arial", size=11)
    for key, value in factors.items():
        pdf.cell(200, 8, txt=f"- {str(key)}: {str(value)}", ln=1)
    pdf.ln(10)
    
    pdf.set_font("Arial", 'B', 12)
    pdf.cell(200, 10, txt="Medical Advice:", ln=1)
    pdf.set_font("Arial", size=11)
    
    if risk_type == "High":
        advice_text = "High risk detected. Immediate clinical consultation with a neurologist is recommended."
    elif risk_type == "Moderate":
        advice_text = "Moderate risk detected. Please improve sleep quality, maintain a healthy diet, and monitor regularly."
    else:
        advice_text = "Low risk detected. Continue maintaining a healthy lifestyle and regular exercise."
    
    pdf.multi_cell(0, 8, txt=advice_text)
    
    # åŠ å…¥å…è²¬è²æ˜åˆ° PDF åº•éƒ¨
    pdf.ln(20)
    pdf.set_font("Arial", 'I', 10)
    pdf.multi_cell(0, 5, txt="Disclaimer: This report is generated by an AI prototype using synthetic and historical data. It is for academic research purposes only and does not constitute a medical diagnosis.")
    
    return pdf.output(dest='S').encode('latin-1')

# ==========================================
# 1. é é¢é…ç½® & æ¸…çˆ½è—ç™½ UI
# ==========================================
st.set_page_config(page_title="AD Risk AI Pro", page_icon="ğŸ§ ", layout="wide")

st.markdown("""
    <style>
    .main {background-color: #FFFFFF;}
    h1, h2, h3 {color: #0056b3; font-family: 'Helvetica Neue', sans-serif;}
    .stButton>button {
        color: white; background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        border: none; border-radius: 8px; padding: 12px 24px; width: 100%; font-weight: bold;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: 0.2s;
    }
    .stButton>button:hover {transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2);}
    [data-testid="stSidebar"] {background-color: #F0F4F8; border-right: 1px solid #D1D9E6;}
    .stChatMessage {background-color: #F8F9FA; border: 1px solid #E9ECEF; border-radius: 12px; padding: 15px; margin-bottom: 10px;}
    [data-testid="stSidebar"] img {display: block; margin-left: auto; margin-right: auto; border-radius: 50%; border: 3px solid #007bff;}
    
    /* è§£é‡‹å€å¡Šæ¨£å¼ */
    .explanation-box {
        background-color: #e8f4fd; 
        border-left: 5px solid #007bff; 
        padding: 15px; 
        border-radius: 5px;
        margin-top: 10px;
        font-size: 0.95em;
        color: #2c3e50;
    }
    
    /* å…è²¬è²æ˜å€å¡Š */
    .disclaimer-box {
        background-color: #fff3cd;
        border: 1px solid #ffeeba;
        color: #856404;
        padding: 10px;
        border-radius: 5px;
        font-size: 0.85em;
        margin-top: 20px;
    }
    </style>
    """, unsafe_allow_html=True)

# ==========================================
# 2. è³‡æ–™è¼‰å…¥èˆ‡æ¨¡å‹è¨“ç·´
# ==========================================
@st.cache_resource
def load_all():
    # ç”Ÿæ´»æ¨¡å‹
    df_l = pd.read_csv('alzheimers_disease_data.csv')
    feat_l = ['Age', 'BMI', 'SleepQuality', 'PhysicalActivity', 'DietQuality', 'FamilyHistoryAlzheimers', 'SystolicBP', 'FunctionalAssessment', 'ADL']
    X_l = df_l[feat_l]; y_l = df_l['Diagnosis']
    X_train_l, X_test_l, y_train_l, y_test_l = train_test_split(X_l, y_l, test_size=0.2, random_state=42)
    clf_l = RandomForestClassifier(n_estimators=100, random_state=42).fit(X_train_l, y_train_l)
    
    # è‡¨åºŠæ¨¡å‹
    df_c_raw = pd.read_csv('oasis_cross-sectional.csv').rename(columns={'Educ': 'EDUC'})
    df_long_raw = pd.read_csv('oasis_longitudinal.csv')
    df_long_raw = df_long_raw[df_long_raw['Visit'] == 1]
    common = ['M/F', 'Age', 'EDUC', 'SES', 'MMSE', 'CDR', 'eTIV', 'nWBV']
    df_oasis = pd.concat([df_c_raw[[c for c in common if c in df_c_raw.columns]], 
                         df_long_raw[[c for c in common if c in df_long_raw.columns]]], ignore_index=True).dropna()
    df_oasis['M/F'] = df_oasis['M/F'].apply(lambda x: 1 if str(x).startswith('F') else 0)
    df_oasis['Target'] = df_oasis['CDR'].apply(lambda x: 1 if x > 0 else 0)
    feat_c = ['M/F', 'Age', 'EDUC', 'SES', 'eTIV', 'nWBV']
    X_c = df_oasis[feat_c]; y_c = df_oasis['Target']
    X_train_c, X_test_c, y_train_c, y_test_c = train_test_split(X_c, y_c, test_size=0.2, random_state=42)
    clf_c = RandomForestClassifier(n_estimators=100, random_state=42).fit(X_train_c, y_train_c)
    
    return clf_l, (X_test_l, y_test_l), clf_c, (X_test_c, y_test_c), df_oasis, df_l

model_l, test_l, model_c, test_c, df_oasis, df_life_raw = load_all()

# ==========================================
# 3. å´é‚Šæ¬„
# ==========================================
try: st.sidebar.image("brain_compare.png", width=150)
except: st.sidebar.image("https://cdn-icons-png.flaticon.com/512/3063/3063176.png", width=150)

st.sidebar.markdown("<h2 style='text-align: center; color: #0056b3;'>AD-AI Pro v6.3</h2>", unsafe_allow_html=True)
st.sidebar.markdown("---")
app_mode = st.sidebar.radio("åŠŸèƒ½å°èˆª", ["ğŸ  ç³»çµ±é¦–é ", "ğŸ¤– AI è¡›æ•™è«®è©¢", "ğŸ¥— ç”Ÿæ´»é›·é”ç¯©æª¢", "ğŸ¥ è‡¨åºŠè½é»åˆ†æ", "ğŸ“Š æ•¸æ“šé©—è­‰ä¸­å¿ƒ"])
st.sidebar.markdown("---")

# [æ–°å¢] å´é‚Šæ¬„å…è²¬è²æ˜
with st.sidebar.expander("âš ï¸ å…è²¬è²æ˜ (Disclaimer)"):
    st.markdown("""
    æœ¬ç³»çµ±ç‚ºå­¸è¡“å°ˆé¡Œç ”ç©¶åŸå‹ (Prototype)ã€‚
    - **ç”Ÿæ´»æ•¸æ“š**ï¼šä½¿ç”¨ Kaggle åˆæˆæ•¸æ“šé›†ï¼Œåƒ…ä¾›æ¨¡å‹é©—è­‰ã€‚
    - **è‡¨åºŠæ•¸æ“š**ï¼šä½¿ç”¨ OASIS å…¬é–‹æ•¸æ“šé›†ã€‚
    - **çµæœç”¨é€”**ï¼šåƒ…ä¾›æ•™å­¸èˆ‡ç ”ç©¶åƒè€ƒï¼Œ**éé†«ç™‚è¨ºæ–·ä¾æ“š**ã€‚è‹¥æœ‰å¥åº·ç–‘æ…®ï¼Œè«‹å‹™å¿…è«®è©¢å°ˆæ¥­é†«å¸«ã€‚
    """)

st.sidebar.caption("Designed by NYCU MED Project Team")

# ==========================================
# 4. é é¢é‚è¼¯
# ==========================================

# --- PAGE 1: é¦–é  ---
if app_mode == "ğŸ  ç³»çµ±é¦–é ":
    st.title("ğŸ§  é˜¿èŒ²æµ·é»˜ç—‡é›™è»Œé¢¨éšªè©•ä¼°ç³»çµ±")
    st.markdown("#### Dual-Track Alzheimer's Risk Assessment System")
    st.divider()
    
    col1, col2 = st.columns([1, 1])
    with col1:
        st.info("ğŸ‘‹ **æ­¡è¿ä½¿ç”¨ v6.3 å°ˆæ¥­ç‰ˆï¼**")
        st.markdown("""
        **ç³»çµ±é—œéµå­—å°è¦½ï¼š**
        - **ğŸ” ç¶²ç«™æ“ä½œ**ï¼šé»æ“Šå·¦ä¸Šè§’ã€Œ>ã€å±•é–‹å´é‚Šæ¬„é¸å–®åˆ‡æ›åŠŸèƒ½ã€‚
        - **ğŸ¤– åŠŸèƒ½ä»‹ç´¹**ï¼šåŒ…å« AI å•ç­”ã€ç”Ÿæ´»ç¿’æ…£åˆ†æã€MRI å½±åƒåˆ¤è®€ã€‚
        - **ğŸ“„ å ±å‘Šç”Ÿæˆ**ï¼šæ”¯æ´ä¸€éµä¸‹è¼‰ PDF é†«å¸«åƒè€ƒå ±å‘Šã€‚
        
        **äº”å¤§æ ¸å¿ƒæ¨¡çµ„ï¼š**
        1. **ğŸ¤– AI è«®è©¢**ï¼šæä¾›å°±é†«æŒ‡å¼•ã€è²»ç”¨è«®è©¢èˆ‡è¡›æ•™å•ç­”ã€‚
        2. **ğŸ¥— ç”Ÿæ´»é›·é”**ï¼šäº”ç¶­åº¦åˆ†æï¼ˆç¡çœ /é£²é£Ÿ/é‹å‹•/è¨˜æ†¶/è‡ªç†ï¼‰ã€‚
        3. **ğŸ¥ è‡¨åºŠè½é»**ï¼šnWBV è…¦èç¸®ç¨‹åº¦å®šä½èˆ‡åŸºå› åŠ æ¬Šã€‚
        4. **ğŸ“Š æ•¸æ“šå¯¦è­‰**ï¼šROC æ›²ç·šèˆ‡æ¨¡å‹æ•ˆèƒ½é©—è­‰ã€‚
        """)
        
        # [æ–°å¢] é¦–é å…è²¬è²æ˜å€å¡Š
        st.markdown("""
        <div class="disclaimer-box">
        âš ï¸ <b>æ³¨æ„ï¼šæ•¸æ“šé™åˆ¶èˆ‡å…è²¬è²æ˜</b><br>
        æœ¬ç³»çµ±ä¹‹ã€Œç”Ÿæ´»å‹æ…‹æ•¸æ“šã€æ¡ç”¨åˆæˆè³‡æ–™é›†é€²è¡Œæ¨¡å‹è¨“ç·´ï¼Œã€Œè‡¨åºŠæ•¸æ“šã€å‰‡åŸºæ–¼ OASIS æ­·å²è³‡æ–™ã€‚ApoE4 åŸºå› åˆ†æåŠŸèƒ½ç›®å‰ç‚ºæ¨¡æ“¬åŠ æ¬Šï¼Œå°šæœªä¸²æ¥çœŸå¯¦åŸºå› åº«ã€‚åˆ†æçµæœåƒ…ä¾›å­¸è¡“ç ”ç©¶åƒè€ƒã€‚
        </div>
        """, unsafe_allow_html=True)

    with col2:
        try: st.image("brain_compare.png", use_container_width=True, caption="Healthy Brain (Left) vs AD Brain (Right)")
        except: st.warning("è«‹ç¢ºä¿ brain_compare.png å·²ä¸Šå‚³")

# --- PAGE 2: AI Chatbot ---
elif app_mode == "ğŸ¤– AI è¡›æ•™è«®è©¢":
    st.title("ğŸ¤– AI è¡›æ•™è«®è©¢åŠ©æ‰‹")
    st.info("ğŸ’¡ æç¤ºï¼šæ‚¨å¯ä»¥å•æˆ‘é—œæ–¼ã€Œé˜¿èŒ²æµ·é»˜ç—‡ã€çš„ç›¸é—œå•é¡Œï¼Œä¾‹å¦‚ç—‡ç‹€ã€é é˜²ã€æ²»ç™‚ã€å°±é†«è³‡è¨Šæˆ–ç¶²ç«™æ“ä½œæ–¹æ³•ã€‚")
    
    if "messages" not in st.session_state:
        st.session_state.messages = [{"role": "assistant", "content": "æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„å¥åº·ç®¡å®¶ã€‚è«‹å•ä»Šå¤©æœ‰ä»€éº¼æˆ‘å¯ä»¥å¹«æ‚¨çš„å—ï¼Ÿ"}]

    for msg in st.session_state.messages:
        with st.chat_message(msg["role"]):
            st.markdown(msg["content"])

    if prompt := st.chat_input("è«‹è¼¸å…¥æ‚¨çš„å•é¡Œ..."):
        st.chat_message("user").markdown(prompt)
        st.session_state.messages.append({"role": "user", "content": prompt})

        q = prompt.lower()
        if any(x in q for x in ["æ“ä½œ", "æ€éº¼ç”¨", "åŠŸèƒ½", "æ•™å­¸"]):
            reply = "ğŸ› ï¸ **ç¶²ç«™æ“ä½œæŒ‡å—**ï¼š\nè«‹é»æ“Šå·¦ä¸Šè§’çš„ **ã€Œ>ã€ç¬¦è™Ÿ** å±•é–‹å´é‚Šæ¬„é¸å–®ï¼Œæ‚¨æœƒçœ‹åˆ°ä»¥ä¸‹åŠŸèƒ½ï¼š\n1. **ç”Ÿæ´»é›·é”ç¯©æª¢**ï¼šè¼¸å…¥æ‚¨çš„æ—¥å¸¸ç¿’æ…£ï¼Œè©•ä¼°é¢¨éšªã€‚\n2. **è‡¨åºŠè½é»åˆ†æ**ï¼šè¼¸å…¥ MRI æ•¸æ“šï¼ŒæŸ¥çœ‹è…¦éƒ¨å¥åº·è½é»ã€‚\n3. **æ•¸æ“šé©—è­‰ä¸­å¿ƒ**ï¼šæŸ¥çœ‹æœ¬ç³»çµ±çš„æº–ç¢ºåº¦æ•¸æ“šã€‚"
        elif any(x in q for x in ["é˜¿èŒ²æµ·é»˜", "å¤±æ™º", "è€äººç—´å‘†", "ä»€éº¼æ˜¯"]):
            reply = "ğŸ§  **ç–¾ç—…ç°¡ä»‹**ï¼š\né˜¿èŒ²æµ·é»˜ç—‡ (Alzheimer's Disease) æ˜¯ä¸€ç¨®ä¸å¯é€†çš„å¤§è…¦ç¥ç¶“é€€åŒ–ç–¾ç—…ã€‚ä¸»è¦ç—…ç†ç‰¹å¾µç‚ºå¤§è…¦å…§ **Î²-é¡æ¾±ç²‰è›‹ç™½æ–‘å¡Š** å †ç©èˆ‡ **Tau è›‹ç™½çºçµ**ï¼Œå°è‡´ç¥ç¶“å…ƒæ­»äº¡èˆ‡è…¦éƒ¨èç¸® (Brain Atrophy)ã€‚"
        elif any(x in q for x in ["é£²é£Ÿ", "åƒ", "ç‡Ÿé¤Š", "é£Ÿç‰©"]):
            reply = "ğŸ¥— **é£²é£Ÿå»ºè­° (MIND Diet)**ï¼š\nç ”ç©¶è­‰å¯¦ MIND é£²é£Ÿå¯é™ä½å¤±æ™ºé¢¨éšªã€‚å»ºè­°å¤šæ”å–ï¼š\n- **ç¶ è‰²è”¬èœ**ã€**å …æœ**ã€**è“æœé¡**ã€**å…¨ç©€é¡**ã€**é­šé¡**ã€‚\n- æ‡‰é¿å…ï¼šç´…è‚‰ã€å¥¶æ²¹ã€èµ·å¸ã€ç”œé»ã€æ²¹ç‚¸é£Ÿå“ã€‚"
        elif any(x in q for x in ["é‹å‹•", "è·‘æ­¥", "æ´»å‹•"]):
            reply = "ğŸƒ **é‹å‹•è™•æ–¹**ï¼š\nå»ºè­°æ¯é€±è‡³å°‘ 150 åˆ†é˜ä¸­ç­‰å¼·åº¦æœ‰æ°§é‹å‹•ã€‚é‹å‹•èƒ½ä¿ƒé€² **BDNF (è…¦æºæ€§ç¥ç¶“æ»‹é¤Šå› å­)** åˆ†æ³Œï¼Œå¢åŠ æµ·é¦¬è¿´é«”ç©ï¼Œå¢å¼·è¨˜æ†¶åŠ›ã€‚"
        elif any(x in q for x in ["ç¡çœ ", "ç¡è¦º", "å¤±çœ "]):
            reply = "ğŸ˜´ **ç¡çœ èˆ‡å¤§è…¦æ’æ¯’**ï¼š\nå¤§è…¦åœ¨ç¡çœ æ™‚æœƒå•Ÿå‹• **ã€Œè† æ·‹å·´ç³»çµ± (Glymphatic System)ã€** æ¸…é™¤ä»£è¬å»¢ç‰©ã€‚é•·æœŸç¡çœ ä¸è¶³æœƒå°è‡´æ¯’ç´ å †ç©ï¼Œå¢åŠ å¤±æ™ºé¢¨éšªã€‚å»ºè­°æ¯æ™šç¡æ»¿ 7-8 å°æ™‚ã€‚"
        elif any(x in q for x in ["è¨ºæ‰€", "æ›è™Ÿ", "çœ‹é†«ç”Ÿ", "é†«é™¢", "ç§‘åˆ¥"]):
            reply = "ğŸ¥ **å°±é†«æŒ‡å¼•**ï¼š\nå»ºè­°æ› **ã€Œç¥ç¶“å…§ç§‘ã€** æˆ– **ã€Œèº«å¿ƒç§‘ã€**ã€‚å„å¤§é†«å­¸ä¸­å¿ƒçš†è¨­æœ‰ã€Œè¨˜æ†¶é–€è¨ºã€ï¼Œå¯æä¾›èªçŸ¥æ¸¬é©— (MMSE) èˆ‡è…¦éƒ¨å½±åƒæª¢æŸ¥ (MRI)ã€‚"
        elif any(x in q for x in ["è²»ç”¨", "éŒ¢", "å¥ä¿", "è‡ªè²»"]):
            reply = "ğŸ’° **è²»ç”¨è³‡è¨Š**ï¼š\nå¥ä¿çµ¦ä»˜å¤§éƒ¨åˆ†çš„é–€è¨ºèˆ‡åŸºæœ¬æª¢æŸ¥ã€‚é«˜éšè‡ªè²»é …ç›®å¦‚ **é¡æ¾±ç²‰è›‹ç™½ PET æƒæ** å¯èƒ½éœ€æ•¸è¬å…ƒï¼Œå»ºè­°è«®è©¢ä¸»æ²»é†«å¸«ã€‚"
        elif any(x in q for x in ["ä½ å¥½", "å—¨", "æ—©å®‰", "è¬è¬"]):
            reply = "ğŸ˜Š æ‚¨å¥½ï¼å¾ˆé«˜èˆˆèƒ½ç‚ºæ‚¨æœå‹™ã€‚è‹¥æœ‰ä»»ä½•é—œæ–¼å¤§è…¦å¥åº·çš„å•é¡Œï¼Œæ­¡è¿éš¨æ™‚æå•ï¼"
        else:
            reply = "æŠ±æ­‰ï¼Œæˆ‘çš„è³‡æ–™åº«ç›®å‰åƒ…æ¶µè“‹ã€Œç–¾ç—…ä»‹ç´¹ã€é£²é£Ÿã€é‹å‹•ã€ç¡çœ ã€å°±é†«ã€è²»ç”¨ã€ç¶²ç«™æ“ä½œã€ç­‰ä¸»é¡Œã€‚æ‚¨å¯ä»¥è©¦è‘—å•ï¼šã€Œé€™å€‹ç¶²ç«™æ€éº¼ç”¨ï¼Ÿã€æˆ–ã€Œè¦å»å“ªè£¡çœ‹é†«ç”Ÿï¼Ÿã€"

        with st.chat_message("assistant"):
            st.markdown(reply)
        st.session_state.messages.append({"role": "assistant", "content": reply})

# --- PAGE 3: ç”Ÿæ´»ç¯©æª¢ ---
elif app_mode == "ğŸ¥— ç”Ÿæ´»é›·é”ç¯©æª¢":
    st.title("ğŸ¥— ç”Ÿæ´»å‹æ…‹é¢¨éšªè©•ä¼°")
    st.markdown("è¼¸å…¥æ‚¨çš„ç”Ÿæ´»ç¿’æ…£ï¼Œç³»çµ±å°‡ç”Ÿæˆé›·é”åœ–ï¼Œä¸¦å°‡æ‚¨çš„æ•¸æ“šèˆ‡è³‡æ–™åº«å¸¸æ¨¡é€²è¡Œæ¯”è¼ƒã€‚")
    st.divider()
    
    c1, c2 = st.columns([1, 2])
    with c1:
        st.subheader("ğŸ“ è¼¸å…¥è³‡æ–™")
        l_age = st.slider("å¹´é½¡", 40, 95, 65); l_gen = st.selectbox("æ€§åˆ¥", ["ç”·", "å¥³"])
        l_bmi = st.slider("BMI (èº«é«”è³ªé‡æŒ‡æ•¸)", 15.0, 35.0, 24.0) 
        l_fam = st.radio("å®¶æ—ç—…å²", ["ç„¡", "æœ‰"])
        l_sleep = st.slider("ç¡çœ å“è³ª (0-10)", 0, 10, 7); l_diet = st.slider("é£²é£Ÿå“è³ª (0-10)", 0, 10, 7)
        l_act = st.slider("é‹å‹•é »ç‡ (0-10)", 0, 10, 5); l_func = st.slider("è¨˜æ†¶è‡ªè©• (0-10)", 0.0, 10.0, 8.0)
        l_adl = st.slider("è‡ªç†èƒ½åŠ› (0-10)", 0.0, 10.0, 10.0)
        btn_run = st.button("ç”Ÿæˆæ·±åº¦åˆ†æå ±å‘Š")

    if btn_run:
        input_data = [[max(60, l_age), l_bmi, l_sleep, l_act, l_diet, (1 if l_fam=="æœ‰" else 0), 120, l_func, l_adl]]
        prob = model_l.predict_proba(input_data)[0][1]
        if l_fam == "æœ‰": prob = min(0.99, prob * 1.3)
        if l_gen == "å¥³": prob = min(0.99, prob * 1.1)
        if l_age < 60: prob *= 0.7
        
        with c2:
            st.subheader("ğŸ“Š åˆ†æçµæœèˆ‡åœ–è¡¨è§£è®€")
            
            # 1. é›·é”åœ–
            cat = ['Sleep', 'Diet', 'Exercise', 'Memory', 'ADL']
            vals = [l_sleep/10, l_diet/10, l_act/10, l_func/10, l_adl/10]
            vals += vals[:1]; ang = np.linspace(0, 2*np.pi, 5, endpoint=False).tolist(); ang += ang[:1]
            fig, ax = plt.subplots(figsize=(4, 4), subplot_kw=dict(polar=True))
            ax.fill(ang, vals, color='#007bff', alpha=0.3); ax.plot(ang, vals, color='#0056b3')
            ax.set_xticks(ang[:-1]); ax.set_xticklabels(cat); st.pyplot(fig)
            
            st.markdown("""
            <div class="explanation-box">
            <b>åœ–è¡¨è§£è®€ï¼š</b><br>
            é€™å¼µé›·é”åœ–é¡¯ç¤ºäº†æ‚¨çš„äº”å¤§å¥åº·ç¶­åº¦ã€‚<b>é¢ç©è¶Šå¤§ä»£è¡¨è¶Šå¥åº·</b>ã€‚<br>
            è‹¥æŸå€‹è§’å‘å…§å‡¹é™·ï¼ˆä¾‹å¦‚ Sleep < 5ï¼‰ï¼Œä»£è¡¨è©²é …ç›®æ˜¯æ‚¨çš„å¼±é»ï¼Œå»ºè­°å„ªå…ˆæ”¹å–„ã€‚
            </div>
            """, unsafe_allow_html=True)
            
            # 2. ç¾¤é«”æ¯”è¼ƒåœ– (BMI)
            st.markdown("#### âš–ï¸ æ‚¨çš„ BMI è½é»åˆ†æ")
            fig2, ax2 = plt.subplots(figsize=(6, 2))
            sns.histplot(data=df_life_raw, x='BMI', kde=True, color='gray', alpha=0.3, ax=ax2)
            ax2.axvline(x=l_bmi, color='red', linestyle='--', linewidth=3, label='You')
            ax2.legend()
            ax2.set_title("Population BMI Distribution")
            st.pyplot(fig2)
            
            st.markdown("""
            <div class="explanation-box">
            <b>BMI åˆ†æï¼š</b><br>
            ç´…è‰²è™›ç·šä»£è¡¨æ‚¨çš„ BMIã€‚ç°è‰²å€åŸŸæ˜¯ 2,000 ä½å—è©¦è€…çš„åˆ†ä½ˆã€‚<br>
            - è‹¥è½åœ¨å³å´ (BMI > 30)ï¼Œä»£è¡¨é«”é‡åé«˜ï¼Œå¯èƒ½å¢åŠ å¿ƒè¡€ç®¡èˆ‡å¤±æ™ºé¢¨éšªã€‚<br>
            - è‹¥è½åœ¨ä¸­é–“ (BMI 18.5-24)ï¼Œå±¬æ–¼å¥åº·ç¯„åœã€‚
            </div>
            """, unsafe_allow_html=True)

            # 3. é¢¨éšªè©•ä¼°
            risk_lvl = "High" if prob > 0.6 else ("Moderate" if prob > 0.3 else "Low")
            st.metric("é æ¸¬é¢¨éšªæ©Ÿç‡", f"{prob:.1%}", delta="High Risk" if risk_lvl=="High" else "Low Risk", delta_color="inverse")
            
            fam_eng = "Yes" if l_fam == "æœ‰" else "No"
            pdf_bytes = create_pdf(f"User_{l_age}", risk_type=risk_lvl, prob=prob, factors={"BMI": l_bmi, "Sleep": l_sleep, "Activity": l_act, "Family History": fam_eng})
            st.download_button("ğŸ“¥ ä¸‹è¼‰ PDF è©•ä¼°å ±å‘Š", data=pdf_bytes, file_name="AD_Risk_Report.pdf", mime="application/pdf")

# --- PAGE 4: è‡¨åºŠè½é» (æ–°å¢ApoE4æ¨¡æ“¬æç¤º) ---
elif app_mode == "ğŸ¥ è‡¨åºŠè½é»åˆ†æ":
    st.title("ğŸ¥ è‡¨åºŠå½±åƒå®šä½åˆ†æ")
    st.markdown("è¼¸å…¥ MRI å½±åƒæ•¸å€¼ï¼Œåˆ†ææ‚¨åœ¨åŒé½¡æ—ç¾¤ä¸­çš„è…¦èç¸®ç¨‹åº¦è½é»ã€‚")
    st.divider()
    
    c1, c2 = st.columns([1, 2])
    with c1:
        st.subheader("ğŸ§  å½±åƒæ•¸æ“š")
        c_age = st.number_input("å¹´é½¡", 60, 95, 75); c_gen = st.selectbox("æ€§åˆ¥", ["Male", "Female"]) 
        c_ses = st.selectbox("ç¤¾ç¶“åœ°ä½ (SES)", [1,2,3,4,5], index=1)
        c_educ = st.number_input("æ•™è‚²å¹´æ•¸", 0, 25, 12); c_nwbv = st.slider("nWBV (è…¦é«”ç©æ¯”)", 0.65, 0.85, 0.75, 0.001)
        c_etiv = st.number_input("eTIV (é¡±å…§å®¹é‡)", 1100, 2000, 1450)
        
        # [ä¿®æ”¹] æ¨™è¨»æ¨¡æ“¬æƒ…å¢ƒ
        c_apoe = st.selectbox("ApoE4 åŸºå› å‹ (æ¨¡æ“¬æƒ…å¢ƒ)", ["Negative", "Positive (e3/e4)", "High Risk (e4/e4)"], 
                              help="æœ¬é¸é …åƒ…ç”¨æ–¼æ¨¡æ“¬åŸºå› é¢¨éšªå°é æ¸¬æ©Ÿç‡çš„å½±éŸ¿ï¼Œä¸ä»£è¡¨çœŸå¯¦åŸºå› æª¢æ¸¬çµæœã€‚")
        
        btn_c = st.button("åŸ·è¡Œè‡¨åºŠè½é»åˆ†æ")

    if btn_c:
        g_val = 1 if c_gen == "Female" else 0
        input_c = [[g_val, c_age, c_educ, c_ses, c_etiv, c_nwbv]]
        prob_c = model_c.predict_proba(input_c)[0][1]
        if "High" in c_apoe: prob_c = min(0.99, prob_c * 1.5)
        elif "Positive" in c_apoe: prob_c = min(0.99, prob_c * 1.2)
        
        with c2:
            st.subheader("ğŸ“ è½é»è¦–è¦ºåŒ– (You are Here)")
            fig, ax = plt.subplots(figsize=(8, 5))
            sns.scatterplot(data=df_oasis, x='Age', y='nWBV', hue='CDR', palette='coolwarm', alpha=0.3, ax=ax)
            ax.scatter(c_age, c_nwbv, color='red', s=250, marker='*', label='You Are Here', edgecolors='black')
            ax.set_ylabel("nWBV (Normalized Whole Brain Volume)")
            ax.legend(); st.pyplot(fig)
            
            st.markdown("""
            <div class="explanation-box">
            <b>åœ–è¡¨è§£è®€ï¼š</b><br>
            <ul>
            <li><b>Xè»¸ (Age)</b>ï¼šå¹´é½¡ã€‚</li>
            <li><b>Yè»¸ (nWBV)</b>ï¼šå…¨è…¦é«”ç©æ¯”ï¼Œæ•¸å€¼è¶Šä½ä»£è¡¨è…¦èç¸®è¶Šåš´é‡ã€‚</li>
            <li><b>èƒŒæ™¯é»</b>ï¼šè—è‰²ä»£è¡¨å¥åº·è€…ï¼Œç´…è‰²ä»£è¡¨å¤±æ™ºæ‚£è€…ã€‚</li>
            <li><b>ç´…æ˜Ÿ (You Are Here)</b>ï¼šæ‚¨çš„ä½ç½®ã€‚è‹¥è½å…¥å³ä¸‹è§’ç´…é»å€ï¼Œä»£è¡¨åœ¨åŒå¹´é½¡å±¤ä¸­ï¼Œæ‚¨çš„è…¦èç¸®è¼ƒåš´é‡ï¼Œé¢¨éšªè¼ƒé«˜ã€‚</li>
            </ul>
            </div>
            """, unsafe_allow_html=True)
            
            st.metric("å½±åƒåˆ†æé¢¨éšªæ©Ÿç‡", f"{prob_c:.1%}")
            if prob_c > 0.5: st.error("ğŸ”´ é«˜åº¦ç–‘ä¼¼é˜¿èŒ²æµ·é»˜ç—‡ç—…è®Š (è…¦èç¸®é¡¯è‘—)")
            else: st.success("ğŸŸ¢ ç›®å‰ç„¡æ˜é¡¯é˜¿èŒ²æµ·é»˜ç—‡ç‰¹å¾µ (è…¦å®¹é‡æ­£å¸¸)")

# --- PAGE 5: æ•¸æ“šé©—è­‰ ---
elif app_mode == "ğŸ“Š æ•¸æ“šé©—è­‰ä¸­å¿ƒ":
    st.title("ğŸ“Š æ•¸æ“šé©—è­‰ä¸­å¿ƒ (Data Validation)")
    st.markdown("#### Model Performance & Static Analysis")
    st.info("æœ¬å€å±•ç¤ºæ¨¡å‹çš„æº–ç¢ºåº¦é©—è­‰ (ROC Curve) èˆ‡è¨“ç·´æ•¸æ“šçš„éœæ…‹åˆ†æåœ–è¡¨ï¼Œè­‰æ˜ç³»çµ±çš„é†«å­¸å¯ä¿¡åº¦ã€‚")
    st.divider()
    
    tab1, tab2, tab3 = st.tabs(["ç”Ÿæ´»æ¨¡å‹æ•ˆèƒ½ (ROC)", "è‡¨åºŠæ¨¡å‹æ•ˆèƒ½ (ROC)", "ğŸ’¾ éœæ…‹åœ–è¡¨å›é¡§"])
    with tab1:
        st.markdown("**ROC æ›²ç·š (Receiver Operating Characteristic)**ï¼šè¡¡é‡äºŒå…ƒåˆ†é¡æ¨¡å‹çš„æ•ˆèƒ½ã€‚AUC è¶Šæ¥è¿‘ 1.0 ä»£è¡¨æº–ç¢ºåº¦è¶Šé«˜ã€‚")
        X_t, y_t = test_l; y_p = model_l.predict_proba(X_t)[:, 1]
        fpr, tpr, _ = roc_curve(y_t, y_p); fig, ax = plt.subplots(figsize=(6,4))
        ax.plot(fpr, tpr, label=f'AUC={auc(fpr, tpr):.2f}', color='#007bff', lw=2)
        ax.plot([0,1],[0,1],'k--'); ax.legend(); st.pyplot(fig)
    with tab2:
        st.markdown("**ROC æ›²ç·š**ï¼šæ­¤è‡¨åºŠæ¨¡å‹åŸºæ–¼ OASIS MRI æ•¸æ“šè¨“ç·´ï¼Œå…·å‚™æ¥µé«˜çš„åˆ†è¾¨èƒ½åŠ› (AUCé€šå¸¸ > 0.8)ã€‚")
        X_t, y_t = test_c; y_p = model_c.predict_proba(X_t)[:, 1]
        fpr, tpr, _ = roc_curve(y_t, y_p); fig, ax = plt.subplots(figsize=(6,4))
        ax.plot(fpr, tpr, label=f'AUC={auc(fpr, tpr):.2f}', color='#28a745', lw=2)
        ax.plot([0,1],[0,1],'k--'); ax.legend(); st.pyplot(fig)
    with tab3:
        st.subheader("OASIS è‡¨åºŠæ•¸æ“šè§£æ")
        c1, c2, c3 = st.columns(3)
        with c1: 
            st.image("scatter_CDR_color.png", use_container_width=True)
            st.caption("â–² **å¹´é½¡ vs MMSE**ï¼šé¡¯ç¤ºéš¨è‘—å¹´é½¡å¢é•·ï¼ŒèªçŸ¥åˆ†æ•¸ (MMSE) ä¸‹é™çš„è¶¨å‹¢ï¼Œç´…é»ä»£è¡¨å¤±æ™ºæ‚£è€…é›†ä¸­å€ã€‚")
        with c2: 
            st.image("heatmap_new.png", use_container_width=True)
            st.caption("â–² **ç›¸é—œæ€§ç†±åœ–**ï¼šé¡è‰²è¶Šç´…/è—ä»£è¡¨ç›¸é—œæ€§è¶Šå¼·ã€‚å¯è¦‹ nWBV èˆ‡ CDR (å¤±æ™ºç­‰ç´š) å‘ˆé¡¯è‘—è² ç›¸é—œã€‚")
        with c3: 
            st.image("feature_importance_new.png", use_container_width=True)
            st.caption("â–² **ç‰¹å¾µé‡è¦æ€§**ï¼šé¡¯ç¤º nWBV (è…¦å®¹é‡) æ˜¯é æ¸¬æ¨¡å‹ä¸­æ¬Šé‡æœ€é«˜çš„å› å­ï¼Œå…¶æ¬¡æ˜¯èªçŸ¥æ¸¬é©—åˆ†æ•¸ã€‚")
        
        st.divider()
        st.subheader("Kaggle ç”Ÿæ´»æ•¸æ“šè§£æ")
        c4, c5, c6 = st.columns(3)
        with c4: 
            st.image("csv3_scatter.png", use_container_width=True)
            st.caption("â–² **ç”Ÿæ´»æ•£ä½ˆåœ–**ï¼šå±•ç¤ºä¸åŒç”Ÿæ´»ç¿’æ…£åˆ†ç¾¤ä¸‹çš„å¥åº·ç‹€æ…‹åˆ†ä½ˆã€‚")
        with c5: 
            st.image("csv3_heatmap.png", use_container_width=True)
            st.caption("â–² **é¢¨éšªå› å­ç†±åœ–**ï¼šåˆ†æç¡çœ ã€é£²é£Ÿã€é‹å‹•ç­‰å› å­ä¹‹é–“çš„é—œè¯æ€§ã€‚")
        with c6: 
            st.image("csv3_bar.png", use_container_width=True)
            st.caption("â–² **ç”Ÿæ´»å› å­æ¬Šé‡**ï¼šé¡¯ç¤ºã€ŒåŠŸèƒ½æ€§è©•ä¼° (Functional Assessment)ã€èˆ‡ã€ŒADLã€å°é æ¸¬çµæœå½±éŸ¿æœ€å¤§ã€‚")
